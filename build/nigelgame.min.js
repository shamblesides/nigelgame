function nigelgame(a){function b(b){function c(){y||(y=!0,i?(++B,B>i&&(B=0,d())):d(),y=!1,window.requestAnimationFrame(c))}function d(){if(b.nextView){var a=b.nextView;b.nextView=null,b=a,A=0}e.fitElement(),b.update&&b.update({viewClock:A,gameClock:z,screen:e,buttons:v}),++A,++z;for(var c in v)v.hasOwnProperty(c)&&++v[c].length}function j(a){h||a.preventDefault();var c=f[a.keyCode];return void 0===c?!0:!v[c]&&(v[c]={length:0},b.buttondown)?b.buttondown(c):void 0}function k(a){var c=f[a.keyCode];return void 0===c?!0:v[c]&&(v[c]=!1,b.buttonup)?b.buttonup(c):void 0}function l(a){b.keypress&&b.keypress(a)&&a.preventDefault()}function m(a){var c=p(a);w.startPoint=c,w.lastPoint=c,w.button=q(a),b.touch&&b.touch({point:c,type:w.button,screenRect:e.getRect()})}function n(a){if(w.startPoint){var c=p(a);c.equals(w.lastPoint)||(b.drag&&b.drag({point:c,lastPoint:w.lastPoint,startPoint:w.startPoint,type:w.button,screenRect:e.getRect()}),w.lastPoint=c)}}function o(a){b.release&&w.startPoint&&w.button===q(a)&&b.release({point:p(a),startPoint:w.startPoint,type:w.button,screenRect:e.getRect()}),w.startPoint=null,w.lastPoint=null}function p(b){var c=b.clientX-(a.clientLeft||0)-(a.offsetLeft||0),d=b.clientY-(a.clientTop||0)-(a.offsetTop||0),f=a.clientWidth||a.innerWidth,g=a.clientHeight||a.innerHeight;return{x:Math.floor(c/f*e.width-e.width/2),y:Math.floor(d/g*e.height-e.height/2)}}function q(a){return 2===a.button?"rightmouse":"mouse"}function r(a){if(a.preventDefault(),a.touches.length===a.changedTouches.length){var c=u(a.changedTouches[0]);x={id:a.changedTouches[0].identifier,startPoint:c,lastPoint:c},b.touch&&b.touch({point:c,type:"touch",screenRect:e.getRect()})}}function s(a){if(a.preventDefault(),x.startPoint)for(var c=0;c<a.changedTouches.length;++c)if(a.changedTouches[c].identifier===x.id){var d=u(a.changedTouches[c]);if(d.equals(x.lastPoint))return;return b.drag&&b.drag({point:d,lastPoint:x.lastPoint,startPoint:x.startPoint,type:"touch",screenRect:e.getRect()}),void(x.lastPoint=d)}}function t(a){if(a.preventDefault(),x.startPoint)for(var c=0;c<a.changedTouches.length;++c)if(a.changedTouches[c].identifier===x.id){if(0===a.targetTouches.length)b.release&&b.release({point:u(a.changedTouches[c]),startPoint:x.startPoint,type:"touch",screenRect:e.getRect()}),x.id=null,x.startPoint=null,x.lastPoint=null;else{var d=a.targetTouches[a.targetTouches.length-1],f=u(d);b.drag&&b.drag({point:f,lastPoint:x.lastPoint,startPoint:x.startPoint,type:"touch",screenRect:e.getRect()}),x.id=d.identifier,x.lastPoint=f}return}}function u(b){var c=b.clientX-(a.clientLeft||0)-(a.offsetLeft||0),d=b.clientY-(a.clientTop||0)-(a.offsetTop||0),f=a.clientWidth||a.innerWidth,g=a.clientHeight||a.innerHeight;return{x:Math.floor(c/f*e.width-e.width/2),y:Math.floor(d/g*e.height-e.height/2)}}var v={},w={startPoint:null,lastPoint:null,button:null},x={id:null,startPoint:null,lastPoint:null},y=!1,z=0,A=0,B=0;f&&(a.addEventListener("keydown",j,!1),a.addEventListener("keyup",k,!1)),h&&a.addEventListener("keypress",l,!1),g&&(a.addEventListener("mousedown",m,!1),a.addEventListener("mouseup",o,!1),a.addEventListener("mousemove",n,!1),a.addEventListener("touchstart",r,!1),a.addEventListener("touchmove",s,!1),a.addEventListener("touchend",t,!1),a.addEventListener("contextmenu",function(a){return a.preventDefault(),!1},!1)),window.requestAnimationFrame(c)}var c=0,d=null,e=new nigelgame.Screen(a);this.setScreenMode=function(){e.mode.apply(e,arguments)},this.setScreenSize=function(){e.setSize.apply(e,arguments)},this.setScreenScale=function(){e.setScale.apply(e,arguments)},this.addSheet=function(a,b,e,f){function g(){nigelgame.sheets[b]=new nigelgame.Sheet(b,i,a,e,f),--c,0===c&&d&&(d(),d=null)}if(!a)throw"missing source image";if(!b)throw"missing alias";if(nigelgame.sheets[b]){var h=nigelgame.sheets[b];if(h.src===a)return;throw"Sheet already defined with alias "+h.alias+"("+h.src+", "+a+")"}++c;var i=new Image;i.onload=g,i.onerror=function(){throw"Failed to load image "+a},i.src=a},this.addJSON=function(a,b){function e(){nigelgame.json[b]=JSON.parse(g.response),--c,0===c&&d&&(d(),d=null)}if(!a)throw"missing json source filename";if(!b)throw"missing alias";if(nigelgame.json[b]){var f=nigelgame.json[b];if(f.src===a)return;throw"Duplicate alias for "+f.alias+"("+f.src+", "+a+")"}++c;var g=new XMLHttpRequest;g.open("GET",a),g.overrideMimeType("application/json"),g.onloadend=e,g.onerror=function(){throw"Error loading JSON file: "+a},g.ontimeout=function(){throw"Request timed out: "+a},g.send()};var f=null;this.bind=function(a){f||(f={});for(var b=1;b<arguments.length;++b)f[arguments[b]]=a};var g=!1;this.activateTouch=function(){g=!0};var h=!1;this.activateKeyboard=function(){h=!0};var i=0;this.setFrameSkip=function(a){i=a};var j=!1;this.start=function(a){if(j)throw new Error("game is already started!");j=!0,c>0?d=function(){b(a)}:b(a)}}nigelgame.sheets={},nigelgame.json={},window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,Math.sign=function(a){return(a=parseFloat(a))?a>0?1:-1:a},nigelgame.Screen=function(a){function b(a,b){n.width=(f=Math.floor(a/h))*h,n.height=(g=Math.floor(b/h))*h}function c(){n.width!==f*h&&(n.width=f*h),n.height!==g*h&&(n.height=g*h)}function d(a,b){e.minWidth*b===e.minHeight*a?(f=e.minWidth,g=e.minHeight):e.minWidth*b<e.minHeight*a?(f=Math.floor(a/b*e.minHeight),g=e.minHeight):(f=e.minWidth,g=Math.floor(b/a*e.minWidth)),h=Math.floor(Math.min(b/g,a/f)),1>h&&(h=1),n.width=f*h,n.height=g*h}a=a||window;var e={name:"adapt"},f=a.clientWidth||a.innerWidth,g=a.clientHeight||a.innerWidth,h=1,i=!0,j=null,k=null,l={x:0,y:0},m={x:0,y:0},n=document.createElement("canvas");n.style.display="block",n.style.margin="auto";var o=n.getContext("2d");(a!==window?a:document.getElementsByTagName("body")[0]).appendChild(n),a!==window&&a.tabIndex<0&&(a.tabIndex=0),Object.defineProperty(this,"element",{get:function(){return a}}),Object.defineProperty(this,"canvas",{get:function(){return n}}),Object.defineProperty(this,"context",{get:function(){return o}}),Object.defineProperty(this,"left",{get:function(){return Math.round(m.x-f*(l.x+1)/2)}}),Object.defineProperty(this,"top",{get:function(){return Math.round(m.y-g*(l.y+1)/2)}}),Object.defineProperty(this,"right",{get:function(){return this.left+f}}),Object.defineProperty(this,"bottom",{get:function(){return this.top+g}}),Object.defineProperty(this,"width",{get:function(){return f}}),Object.defineProperty(this,"height",{get:function(){return g}}),Object.defineProperty(this,"drawScale",{get:function(){return h}}),Object.defineProperty(this,"font",{set:function(a){if(!nigelgame.sheets[a])throw new Error("invalid font: "+a);k=a},get:function(){if(!k)throw new Error("font has not been set.");return k}}),this.origin=function(a,b){if(0===arguments.length)return{x:l.x,y:l.y};if(2!==arguments.length)throw new Error("invalid arguments for origin");l={x:a,y:b}},this.offset=function(a,b){if(0===arguments.length)return{x:m.x,y:m.y};if(2!==arguments.length)throw new Error("invalid arguments for offset");m={x:a,y:b}},this.mode=function(b){if(0===arguments.length)return e.name;if("adapt"===b)e={name:"adapt"},h=arguments[1]||1,n.style.width="",n.style.height="";else if("fixed"===b)e={name:"fixed"},arguments.length<=2?(h=arguments[1]||1,f=Math.floor((a.clientWidth||a.innerWidth)/h),g=Math.floor((a.clientHeight||a.innerHeight)/h)):(f=arguments[1],g=arguments[2],h=arguments[3]||1),n.style.width="",n.style.height="";else{if("scale-overflow"!==b)throw new Error("scale"===b?"not yet supported.":"unknown mode type.");e={name:"scale-overflow",minWidth:arguments[1]||a.clientWidth||a.innerWidth,minHeight:arguments[2]||a.clientHeight||a.innerHeight},n.style.width="100%",n.style.height="100%"}i=!0,j=null},this.setSize=function(a,b){if("fixed"===e.name||"scale"===e.name)f=a,g=b;else{if("scale-overflow"!==e.name)throw new Error("screen mode does not support setSize: "+e.name);e.minWidth=a,e.minHeight=b}},this.setScale=function(a){if("adapt"!==e.name&&"fixed"!==e.name)throw new Error("screen mode does not support setScale: "+e.name);h=a},this.fitElement=function(){var f=a.clientWidth||a.innerWidth,g=a.clientHeight||a.innerHeight;i=!j||j.w!==f||j.h!==g,i&&("adapt"===e.name?b(f,g):"fixed"===e.name?c(f,g):"scale-overflow"===e.name&&d(f,g),h>1&&(this.context.webkitImageSmoothingEnabled=this.context.imageSmoothingEnabled=this.context.mozImageSmoothingEnabled=this.context.oImageSmoothingEnabled=!1),a===window&&window.scrollTo(0,0),j={w:f,h:g})}},nigelgame.Panel=function(){},nigelgame.Screen.prototype.panel=function(a,b,c,d,e,f){return new nigelgame.Panel(this,a,b,c,d,e,f)},nigelgame.Screen.prototype.toCanvasCoords=function(a,b,c,d,e,f){if(-1===[2,4,6].indexOf(arguments.length))throw new Error("bad number of arguments to toCanvasCoords");(void 0===e||null===e)&&(e=this.origin().x),(void 0===f||null===f)&&(f=this.origin().y);var g=Math.round(a+this.offset().x+this.width*(this.origin().x+1)/2-(c||0)*(e+1)/2),h=Math.round(b+this.offset().y+this.height*(this.origin().y+1)/2-(d||0)*(f+1)/2),i=this.drawScale;return 2===arguments.length?{x:g*i,y:h*i}:{x:g*i,y:h*i,width:c*i,height:d*i}},nigelgame.Screen.prototype.clear=nigelgame.Panel.prototype.clear=function(a,b,c,d,e,f){if(-1===[0,4,6].indexOf(arguments.length))throw new Error("bad arguments for clear");if(0===arguments.length)return void(this instanceof nigelgame.Screen&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height));var g=this.toCanvasCoords(a,b,c,d,e,f);this.context.clearRect(g.x,g.y,g.width,g.height)},nigelgame.Screen.prototype.reset=function(){this.clear(),this.origin(0,0),this.offset(0,0)},nigelgame.Screen.prototype.fill=nigelgame.Panel.prototype.fill=function(a,b,c,d,e){if(-1===[1,5,7].indexOf(arguments.length))throw new Error("bad arguments for fill");var f=this.context.fillStyle;if(this.context.fillStyle=a,1===arguments.length)return this instanceof nigelgame.Screen&&this.context.fillRect(0,0,this.canvas.width,this.canvas.height),void(this.context.fillStyle=f);var g=this.toCanvasCoords(b,c,d,e);this.context.fillRect(g.x,g.y,g.width,g.height),this.context.fillStyle=f},nigelgame.Screen.prototype.blit=nigelgame.Panel.prototype.blit=function(a,b){if(-1===[4,5,6,7].indexOf(arguments.length))throw new Error("bad arguments for blit");var c=arguments.length%2===1&&arguments[2]||"",d=arguments[arguments.length%2===0?2:3],e=arguments[arguments.length%2===0?3:4],f=arguments.length>=6?arguments[arguments.length-2]:null,g=arguments.length>=6?arguments[arguments.length-1]:null,h=nigelgame.sheets[a];if(!h)throw new Error("unknown sheet: "+a);var i=void 0!==b&&null!==b?h.getSprite(b):h,j=this.toCanvasCoords(d,e,i.width,i.height,f,g),k=-1!==c.indexOf("h")?1:0,l=-1!==c.indexOf("v")?1:0;c&&(this.context.translate(this.canvas.width*k,this.canvas.height*l),this.context.scale(k?-1:1,l?-1:1)),this.context.drawImage(i.img,i.left,i.top,i.width,i.height,(this.canvas.width-j.width)*k+j.x*(k?-1:1),(this.canvas.height-j.height)*l+j.y*(l?-1:1),j.width,j.height),c&&(this.context.translate(this.canvas.width*k,this.canvas.height*l),this.context.scale(k?-1:1,l?-1:1))},nigelgame.Screen.prototype.write=nigelgame.Panel.prototype.write=function(a,b,c,d){var e=nigelgame.sheets[this.font];d=d||{},(d.cols||d.rows)&&(a=nigelgame.wrapString(a,d.cols,d.rows));var f=d&&d.anchor||{};void 0===f.x&&(f.x=this.origin().x||0),void 0===f.y&&(f.y=this.origin().y||0);for(var g=a.split("\n"),h=0,i=0;i<g.length;++i)h=Math.max(g[i].length,h);var j=0;if(d&&d.align&&"left"!==d.align)if("center"===d.align)j=.5;else{if("right"!==d.align)throw"unknown text alignment: "+d.align;j=1}else j=0;for(var k=this.toCanvasCoords(b,c,e.spriteWidth*h,e.spriteHeight*g.length),l=e.spriteWidth*this.drawScale,m=e.spriteHeight*this.drawScale,n=0;n<g.length;++n)for(var o=Math.round((h-g[n].length)*j*e.spriteWidth)*this.drawScale,p=0;p<g[n].length;++p){var q=g[n].charCodeAt(p)-32,r=e.getSprite(q);this.context.drawImage(r.img,r.left,r.top,r.width,r.height,k.x+o+p*l,k.y+n*m,l,m)}},nigelgame.Sheet=function(a,b,c,d,e){d=d||b.width,e=e||b.height;var f=Math.floor(b.width/d),g=Math.floor(b.height/e),h=f*g;Object.defineProperty(this,"alias",{get:function(){return a}}),Object.defineProperty(this,"img",{get:function(){return b}}),Object.defineProperty(this,"src",{get:function(){return c}}),Object.defineProperty(this,"left",{get:function(){return 0}}),Object.defineProperty(this,"top",{get:function(){return 0}}),Object.defineProperty(this,"width",{get:function(){return b.width}}),Object.defineProperty(this,"height",{get:function(){return b.height}}),Object.defineProperty(this,"spriteWidth",{get:function(){return d}}),Object.defineProperty(this,"spriteHeight",{get:function(){return e}}),Object.defineProperty(this,"numCols",{get:function(){return f}}),Object.defineProperty(this,"numRows",{get:function(){return g}}),Object.defineProperty(this,"numSprites",{get:function(){return h}})},nigelgame.Sheet.prototype.getSprite=function(a){return new nigelgame.Sprite(this,a)},nigelgame.Sprite=function(a,b){if(void 0===b||null===b)throw new Error("bad frame while constructing sprite");"number"==typeof b&&b%1===0&&(b={col:b%a.numCols,row:Math.floor(b/a.numCols)});var c=void 0!==b.x?b.x:b.col?b.col*a.spriteWidth:0,d=void 0!==b.y?b.y:b.row?b.row*a.spriteHeight:0,e=void 0!==b.width?b.width:void 0!==b.col?a.spriteWidth:a.width-c,f=void 0!==b.height?b.height:void 0!==b.row?a.spriteHeight:a.height-d;Object.defineProperty(this,"img",{get:function(){return a.img}}),Object.defineProperty(this,"left",{get:function(){return c}}),Object.defineProperty(this,"top",{get:function(){return d}}),Object.defineProperty(this,"width",{get:function(){return e}}),Object.defineProperty(this,"height",{get:function(){return f}})},nigelgame.wrapString=function(a,b,c){if(!a)return a;var d=".{1,"+b+"}(\\s|$)|.{"+b+"}|.+$",e=a.match(RegExp(d,"g"));c&&(e=e.slice(0,c));for(var f=0;f<e.length;++f)e[f]=e[f].trim();return e.join("\n")};
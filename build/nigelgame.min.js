var nigelgame={};nigelgame.start=function(a){function b(){a.json&&a.json.length>0?nigelgame.loadJSON(a.json,c):c()}function c(){a.keyBinds&&(a.element.addEventListener("keydown",f,!1),a.element.addEventListener("keyup",g,!1)),a.useKeyboard&&a.element.addEventListener("keypress",h,!1),a.useTouch&&(a.element.addEventListener("mousedown",i,!1),a.element.addEventListener("mouseup",k,!1),a.element.addEventListener("mousemove",j,!1),a.element.addEventListener("touchstart",n,!1),a.element.addEventListener("touchmove",o,!1),a.element.addEventListener("touchend",p,!1),a.element.addEventListener("contextmenu",function(a){return a.preventDefault(),!1},!1)),r=new a.view,a.framerate&&window.setInterval(function(){v=!0},a.framerate),window.requestAnimationFrame(d)}function d(){w||(w=!0,(!a.framerate||v)&&(v=!1,a.frameskip?(++z,z>a.frameskip&&(z=0,e())):e()),w=!1,window.requestAnimationFrame(d))}function e(){if(r.nextView){var a=r.nextView;r.nextView=null,r=a,y=0}var b={total:x,view:y};r.update&&r.update(b),A.fitElement(),r.draw&&r.draw(A,b),++y,++x}function f(b){a.useKeyboard||b.preventDefault();var c=a.keyBinds[b.keyCode];return void 0===c?!0:!s[c]&&(s[c]=!0,r.buttondown)?r.buttondown(c):void 0}function g(b){var c=a.keyBinds[b.keyCode];return void 0===c?!0:s[c]&&(s[c]=!1,r.buttonup)?r.buttonup(c):void 0}function h(a){(!r.keypress||r.keypress(a))&&a.preventDefault()}function i(a){var b=l(a);t.startPoint=b,t.lastPoint=b,t.button=m(a),r.touch&&r.touch({point:b,type:t.button,screenRect:A.getRect()})}function j(a){if(t.startPoint){var b=l(a);b.equals(t.lastPoint)||(r.drag&&r.drag({point:b,lastPoint:t.lastPoint,startPoint:t.startPoint,type:t.button,screenRect:A.getRect()}),t.lastPoint=b)}}function k(a){r.release&&t.startPoint&&t.button===m(a)&&r.release({point:l(a),startPoint:t.startPoint,type:t.button,screenRect:A.getRect()}),t.startPoint=null,t.lastPoint=null}function l(b){var c=b.clientX-(a.element.clientLeft||0)-(a.element.offsetLeft||0),d=b.clientY-(a.element.clientTop||0)-(a.element.offsetTop||0),e=a.element.clientWidth||a.element.innerWidth,f=a.element.clientHeight||a.element.innerHeight;return{x:Math.floor(c/e*A.width-A.width/2),y:Math.floor(d/f*A.height-A.height/2)}}function m(a){return 2===a.button?"rightmouse":"mouse"}function n(a){if(a.preventDefault(),a.touches.length===a.changedTouches.length){var b=q(a.changedTouches[0]);u={id:a.changedTouches[0].identifier,startPoint:b,lastPoint:b},r.touch&&r.touch({point:b,type:"touch",screenRect:A.getRect()})}}function o(a){if(a.preventDefault(),u.startPoint)for(var b=0;b<a.changedTouches.length;++b)if(a.changedTouches[b].identifier===u.id){var c=q(a.changedTouches[b]);if(c.equals(u.lastPoint))return;return r.drag&&r.drag({point:c,lastPoint:u.lastPoint,startPoint:u.startPoint,type:"touch",screenRect:A.getRect()}),void(u.lastPoint=c)}}function p(a){if(a.preventDefault(),u.startPoint)for(var b=0;b<a.changedTouches.length;++b)if(a.changedTouches[b].identifier===u.id){if(0===a.targetTouches.length)r.release&&r.release({point:q(a.changedTouches[b]),startPoint:u.startPoint,type:"touch",screenRect:A.getRect()}),u.id=null,u.startPoint=null,u.lastPoint=null;else{var c=a.targetTouches[a.targetTouches.length-1],d=q(c);r.drag&&r.drag({point:d,lastPoint:u.lastPoint,startPoint:u.startPoint,type:"touch",screenRect:A.getRect()}),u.id=c.identifier,u.lastPoint=d}return}}function q(b){var c=b.clientX-(a.element.clientLeft||0)-(a.element.offsetLeft||0),d=b.clientY-(a.element.clientTop||0)-(a.element.offsetTop||0),e=a.element.clientWidth||a.element.innerWidth,f=a.element.clientHeight||a.element.innerHeight;return{x:Math.floor(c/e*A.width-A.width/2),y:Math.floor(d/f*A.height-A.height/2)}}var r,s={},t={startPoint:null,lastPoint:null,button:null},u={id:null,startPoint:null,lastPoint:null},v=!0,w=!1,x=0,y=0,z=0,A=new nigelgame.Screen(a.element,a.scaleMode,a.width,a.height,a.scale);a.sheets&&a.sheets.length>0?nigelgame.loadImages(a.sheets,b):b()},window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,Math.sign=function(a){return(a=parseFloat(a))?a>0?1:-1:a},nigelgame.json={},nigelgame.loadJSON=function(a,b){function c(a){function c(){nigelgame.json[a.alias]=JSON.parse(f.response),++e,e>=d&&b()}var f=new XMLHttpRequest;f.open("GET",a.src),f.overrideMimeType("application/json"),f.onloadend=c,f.onerror=function(){throw"Error loading JSON file: "+a.src},f.ontimeout=function(){throw"Request timed out: "+a.src},f.send(),++d}for(var d=0,e=0,f=0;f<a.length;++f){if(!a[f].src)throw"missing json source filename";if(!a[f].alias)throw"missing alias";if(nigelgame.json[a[f].alias]){var g=nigelgame.sheets[a[f].alias];throw"Duplicate alias for "+g.alias+"("+g.src+", "+a[f].src+")"}c(a[f])}0===d&&b()},nigelgame.Screen=function(a,b,c,d,e){if(!a)throw new Error("provide element");if(b=b&&b.toLowerCase()||"none",-1===nigelgame.Screen.MODES.indexOf(b))throw new Error("unsupported screen mode: "+b);if(c=c||a.clientWidth||a.innerWidth,d=d||a.clientHeight||a.innerWidth,1>e)throw new Error("invalid scale");var f=document.createElement("canvas");f.style.display="block",f.style.width="100%",f.style.height="100%";var g=f.getContext("2d");(a!==window?a:document.getElementsByTagName("body")[0]).appendChild(f),a!==window&&a.tabIndex<0&&(a.tabIndex=0),Object.defineProperty(this,"element",{get:function(){return a}}),Object.defineProperty(this,"canvas",{get:function(){return f}}),Object.defineProperty(this,"context",{get:function(){return g}}),Object.defineProperty(this,"mode",{get:function(){return b}}),Object.defineProperty(this,"minWidth",{get:function(){return c}}),Object.defineProperty(this,"minHeight",{get:function(){return d}}),this.width=void 0,this.height=void 0,this.drawScale=e||1,this.wasResized=!1,this.prevDims=null,Object.defineProperty(this,"left",{get:function(){return Math.round(this.offset.x-this.width*(this.origin.x+1)/2)}}),Object.defineProperty(this,"top",{get:function(){return Math.round(this.offset.y-this.height*(this.origin.y+1)/2)}}),Object.defineProperty(this,"right",{get:function(){return this.left+this.width}}),Object.defineProperty(this,"bottom",{get:function(){return this.top+this.height}}),this.font=null;var h={x:0,y:0},i={x:0,y:0};this.origin=function(a,b){if(0===arguments.length)return{x:h.x,y:h.y};if(2!==arguments.length)throw new Error("invalid arguments for origin");h={x:a,y:b}},this.offset=function(a,b){if(0===arguments.length)return{x:i.x,y:i.y};if(2!==arguments.length)throw new Error("invalid arguments for offset");i={x:a,y:b}}},nigelgame.Screen.MODES=["none","adapt","scale-adapt"],nigelgame.Screen.prototype.fitElement=function(){var a=this.element.clientWidth||this.element.innerWidth,b=this.element.clientHeight||this.element.innerHeight;this.wasResized=!this.prevDims||this.prevDims.width!==a||this.prevDims.height!==b,this.wasResized&&("none"===this.mode?this.fitElementModeNone(a,b):"adapt"===this.mode?this.fitElementModeAdapt(a,b):"scale-adapt"===this.mode&&this.fitElementModeScaleAdapt(a,b),this.prevDims={height:b,width:a})},nigelgame.Screen.prototype.fitElementModeNone=function(){this.prevDims||(this.canvas.width=(this.width=this.minWidth)*this.drawScale,this.canvas.height=(this.height=this.minHeight)*this.drawScale,this.drawScale>1&&this.crispy())},nigelgame.Screen.prototype.fitElementModeAdapt=function(a,b){this.canvas.width=(this.width=Math.floor(a/this.drawScale))*this.drawScale,this.canvas.height=(this.height=Math.floor(b/this.drawScale))*this.drawScale,this.drawScale>1&&this.crispy()},nigelgame.Screen.prototype.fitElementModeScaleAdapt=function(a,b){this.minWidth*b===this.minHeight*a?(this.width=this.minWidth,this.height=this.minHeight):this.minWidth*b<this.minHeight*a?(this.width=Math.floor(a/b*this.minHeight),this.height=this.minHeight):(this.width=this.minWidth,this.height=Math.floor(b/a*this.minWidth)),this.drawScale=Math.floor(Math.min(b/this.height,a/this.width)),this.drawScale<1&&(this.drawScale=1),this.canvas.width=this.width*this.drawScale,this.canvas.height=this.height*this.drawScale,this.crispy(),this.element===window&&window.scrollTo(0,0)},nigelgame.Screen.prototype.crispy=function(){this.context.webkitImageSmoothingEnabled=this.context.imageSmoothingEnabled=this.context.mozImageSmoothingEnabled=this.context.oImageSmoothingEnabled=!1},nigelgame.Panel=function(){},nigelgame.Screen.prototype.panel=function(a,b,c,d,e,f){return new nigelgame.Panel(this,a,b,c,d,e,f)},nigelgame.Screen.prototype.toCanvasCoords=function(a,b,c,d){if(2!==arguments.length&&4!==arguments.length)throw new Error("bad number of arguments to toCanvasCoords");var e=Math.round(a+this.offset().x+(this.width-(c||0))*(this.origin().x+1)/2),f=Math.round(b+this.offset().y+(this.height-(d||0))*(this.origin().y+1)/2),g=this.drawScale;return 2===arguments.length?{x:e*g,y:f*g}:{x:e*g,y:f*g,width:c*g,height:d*g}},nigelgame.Screen.prototype.clear=nigelgame.Panel.prototype.clear=function(a,b,c,d){if(0===arguments.length)return void(this instanceof nigelgame.Screen&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height));if(4!==arguments.length)throw new Error("bad arguments for clear");var e=this.toCanvasCoords(a,b,c,d);this.context.clearRect(e.x,e.y,e.width,e.height)},nigelgame.Screen.prototype.reset=function(){this.clear(),this.origin(0,0),this.offset(0,0)},nigelgame.Screen.prototype.fill=nigelgame.Panel.prototype.fill=function(a,b,c,d,e){if(1!==arguments.length&&5!==arguments.length)throw new Error("bad arguments for fill");var f=this.context.fillStyle;if(this.context.fillStyle=a,1===arguments.length)return this instanceof nigelgame.Screen&&this.context.fillRect(0,0,this.canvas.width,this.canvas.height),void(this.context.fillStyle=f);var g=this.toCanvasCoords(b,c,d,e);this.context.fillRect(g.x,g.y,g.width,g.height),this.context.fillStyle=f},nigelgame.Screen.prototype.blit=nigelgame.Panel.prototype.blit=function(a,b,c,d){var e=nigelgame.sheets[a];if(!e)throw new Error("unknown sheet: "+a);var f=void 0!==b&&null!==b?e.getSprite(b):e,g=this.toCanvasCoords(c,d,f.width,f.height);this.context.drawImage(f.img,f.left,f.top,f.width,f.height,g.x,g.y,g.width,g.height)},nigelgame.Screen.prototype.write=nigelgame.Panel.prototype.write=function(a,b,c,d){if(!this.font)throw new Error("font has not been set.");var e=nigelgame.sheets[this.font];if(!e)throw new Error("invalid font: "+this.font);d=d||{},(d.cols||d.rows)&&(a=nigelgame.wrapString(a,d.cols,d.rows));var f=d&&d.anchor||{};void 0===f.x&&(f.x=this.origin().x||0),void 0===f.y&&(f.y=this.origin().y||0);for(var g=a.split("\n"),h=0,i=0;i<g.length;++i)h=Math.max(g[i].length,h);var j=0;if(d&&d.align&&"left"!==d.align)if("center"===d.align)j=.5;else{if("right"!==d.align)throw"unknown text alignment: "+d.align;j=1}else j=0;for(var k=this.toCanvasCoords(b,c,e.spriteWidth*h,e.spriteHeight*g.length),l=e.spriteWidth*this.drawScale,m=e.spriteHeight*this.drawScale,n=0;n<g.length;++n)for(var o=Math.round((h-g[n].length)*j*e.spriteWidth)*this.drawScale,p=0;p<g[n].length;++p){var q=g[n].charCodeAt(p)-32,r=e.getSprite(q);this.context.drawImage(r.img,r.left,r.top,r.width,r.height,k.x+o+p*l,k.y+n*m,l,m)}},nigelgame.sheets={},nigelgame.loadImages=function(a,b){function c(a){function c(){nigelgame.sheets[a.alias]=new nigelgame.Sheet(a.alias,f,a.src,a.spriteWidth,a.spriteHeight),++e,e>=d&&b()}var f=new Image;f.onload=c,f.onerror=function(){throw"Failed to load image "+a.src},f.src=a.src,++d}for(var d=0,e=0,f=0;f<a.length;++f){if(!a[f].src)throw"missing source image";if(!a[f].alias)throw"missing alias";if(nigelgame.sheets[a[f].alias]){var g=nigelgame.sheets[a[f].alias];if(g.src===a[f].src)continue;throw"Sheet already defined with alias "+g.alias+"("+g.src+", "+a[f].src+")"}c(a[f])}0===d&&b()},nigelgame.Sheet=function(a,b,c,d,e){d=d||b.width,e=e||b.height;var f=Math.floor(b.width/d),g=Math.floor(b.height/e),h=f*g;Object.defineProperty(this,"alias",{get:function(){return a}}),Object.defineProperty(this,"img",{get:function(){return b}}),Object.defineProperty(this,"src",{get:function(){return c}}),Object.defineProperty(this,"left",{get:function(){return 0}}),Object.defineProperty(this,"top",{get:function(){return 0}}),Object.defineProperty(this,"width",{get:function(){return b.width}}),Object.defineProperty(this,"height",{get:function(){return b.height}}),Object.defineProperty(this,"spriteWidth",{get:function(){return d}}),Object.defineProperty(this,"spriteHeight",{get:function(){return e}}),Object.defineProperty(this,"numCols",{get:function(){return f}}),Object.defineProperty(this,"numRows",{get:function(){return g}}),Object.defineProperty(this,"numSprites",{get:function(){return h}})},nigelgame.Sheet.prototype.getSprite=function(a){return new nigelgame.Sprite(this,a)},nigelgame.Sprite=function(a,b){if(void 0===b||null===b)throw new Error("bad frame while constructing sprite");"number"==typeof b&&b%1===0&&(b={col:b%a.numCols,row:Math.floor(b/a.numCols)});var c=void 0!==b.x?b.x:b.col?b.col*a.spriteWidth:0,d=void 0!==b.y?b.y:b.row?b.row*a.spriteHeight:0,e=void 0!==b.width?b.width:void 0!==b.col?a.spriteWidth:a.width-c,f=void 0!==b.height?b.height:void 0!==b.row?a.spriteHeight:a.height-d;Object.defineProperty(this,"img",{get:function(){return a.img}}),Object.defineProperty(this,"left",{get:function(){return c}}),Object.defineProperty(this,"top",{get:function(){return d}}),Object.defineProperty(this,"width",{get:function(){return e}}),Object.defineProperty(this,"height",{get:function(){return f}})},nigelgame.wrapString=function(a,b,c){if(!a)return a;var d=".{1,"+b+"}(\\s|$)|.{"+b+"}|.+$",e=a.match(RegExp(d,"g"));c&&(e=e.slice(0,c));for(var f=0;f<e.length;++f)e[f]=e[f].trim();return e.join("\n")};
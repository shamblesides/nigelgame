var nigelgame={};nigelgame.start=function(a){function b(){a.keyBinds&&(a.element.addEventListener("keydown",d,!1),a.element.addEventListener("keyup",e,!1)),a.useTouch&&(a.element.addEventListener("mousedown",f,!1),a.element.addEventListener("mouseup",h,!1),a.element.addEventListener("mousemove",g,!1)),window.requestAnimationFrame(c),window.setInterval(function(){n=!0},a.minFreq||33)}function c(){if(!o){if(o=!0,n){if(n=!1,m.nextView){var a=m.nextView;m.nextView=null,m=a,q=0}var b={total:p,view:q};m.update&&m.update(b),r.fitElement(),m.draw&&m.draw(r,b),++q,++p}o=!1,window.requestAnimationFrame(c)}}function d(b){var c=a.keyBinds[b.keyCode];void 0!==c&&(b.preventDefault(),k[c]||(k[c]=!0,m.keydown&&m.keydown(c)))}function e(b){var c=a.keyBinds[b.keyCode];void 0!==c&&k[c]&&(k[c]=!1,m.keyup&&m.keyup(c))}function f(a){var b=j(a);l.startPoint=b,l.lastPoint=b,m.touch&&m.touch(b,"mouse")}function g(a){if(l.startPoint){var b=j(a);b.startPoint=l.startPoint,b.lastPoint=l.lastPoint,b.lastPoint.startPoint=void 0,b.lastPoint.lastPoint=void 0,l.lastPoint=b,m.drag&&m.drag(b,"mouse")}}function h(a){if(m.release&&l.startPoint){var b=j(a);b.startPoint=l.startPoint,m.release(b,"mouse")}l.startPoint=null,l.lastPoint=null}function i(a,b){var c=r.width,d=r.height;return{fromScreenLeft:a,fromScreenTop:b,fromScreenRight:c-a,fromScreenBottom:d-b,fromCenterX:Math.round(a-c/2),fromCenterY:Math.round(b-d/2),hPercent:a/c*100,vPercent:b/d*100,inBounds:a>=0&&b>=0&&c>a&&d>b}}function j(b){var c=b.clientX-(a.element.clientLeft||0)-(a.element.offsetLeft||0),d=b.clientY-(a.element.clientTop||0)-(a.element.offsetTop||0);return i(Math.floor(c*r.width/(a.element.clientWidth||a.element.innerWidth)),Math.floor(d*r.height/(a.element.clientHeight||a.element.innerHeight)))}var k={},l={startPoint:null,lastPoint:null},m=a.view,n=!0,o=!1,p=0,q=0,r=new nigelgame.Screen(a.element,a.width||null,a.height||null);a.sheets&&a.sheets.length>0?nigelgame.loadImages(a.sheets,b):b()},window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,nigelgame.Point=function(a){this.x=a.x||0,this.y=a.y||0,this.xAnchor=a.xAnchor||0,this.yAnchor=a.yAnchor||0},nigelgame.Point.prototype.xFor=function(a){return this.xAnchor*a.width/2+this.x},nigelgame.Point.prototype.yFor=function(a){return this.yAnchor*a.height/2+this.y},nigelgame.Point.prototype.translate=function(a){return new nigelgame.Point({x:this.x+(a.x||0),y:this.y+(a.y||0),xAnchor:this.xAnchor+(a.xAnchor||0),yAnchor:this.yAnchor+(a.yAnchor||0)})},nigelgame.Rect=function(a){if((void 0!==a.left)+(void 0!==a.right)+(void 0!==a.width)!==2)throw"Horizontal boundaries are not well defined.";if((void 0!==a.top)+(void 0!==a.bottom)+(void 0!==a.height)!==2)throw"Vertical boundaries are not well defined.";if(a.point instanceof nigelgame.Point)this.point=a.point;else if("object"==typeof a.point)this.point=new nigelgame.Point(a.point);else{if(a.point)throw"strange point given to Rect";this.point=new nigelgame.Point({})}this.left=void 0!==a.left?a.left:a.width-a.right,this.right=void 0!==a.right?a.right:a.width-a.left,this.top=void 0!==a.top?a.top:a.height-a.bottom,this.bottom=void 0!==a.bottom?a.bottom:a.height-a.top,this.width=this.left+this.right,this.height=this.top+this.bottom},nigelgame.Rect.prototype.leftFor=function(a){return this.point.xFor(a)-this.left},nigelgame.Rect.prototype.rightFor=function(a){return this.point.xFor(a)+this.right},nigelgame.Rect.prototype.topFor=function(a){return this.point.yFor(a)-this.top},nigelgame.Rect.prototype.bottomFor=function(a){return this.point.yFor(a)+this.bottom},nigelgame.Rect.prototype.translate=function(a){this.point.translate(a)},nigelgame.Rect.prototype.resize=function(a){return new nigelgame.Rect({point:this.point,left:this.left+(a.left||0),right:this.right+(a.right||0),top:this.top+(a.top||0),bottom:this.bottom+a.bottom})},nigelgame.Screen=function(a,b,c){this.element=a,this.minWidth=b||a.clientWidth||a.innerWidth,this.minHeight=c||a.clientHeight||a.innerWidth,this.width=void 0,this.height=void 0,this.drawScale=void 0,this.canvas=document.createElement("canvas"),this.canvas.style.display="block",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.backgroundColor="#000",this.context=this.canvas.getContext("2d");var d=a!==window?a:document.getElementsByTagName("body")[0];d.appendChild(this.canvas),this.element!==window&&this.element.tabIndex<0&&(this.element.tabIndex=0),this.fitElement()},nigelgame.Screen.prototype.fitElement=function(){var a=this.element.clientWidth||this.element.innerWidth,b=this.element.clientHeight||this.element.innerHeight;this.prevDims&&this.prevDims.width===a&&this.prevDims.height===b||(this.minWidth*b===this.minHeight*a?(this.width=this.minWidth,this.height=this.minHeight):this.minWidth*b<this.minHeight*a?(this.width=Math.floor(a/b*this.minHeight),this.height=this.minHeight):(this.width=this.minWidth,this.height=Math.floor(b/a*this.minWidth)),this.drawScale=Math.floor(Math.min(b/this.height,a/this.width)),this.drawScale<1&&(this.drawScale=1),this.canvas.width=this.width*this.drawScale,this.canvas.height=this.height*this.drawScale,this.context.webkitImageSmoothingEnabled=this.context.imageSmoothingEnabled=this.context.mozImageSmoothingEnabled=this.context.oImageSmoothingEnabled=!1,this.prevDims={height:b,width:a},this.element===window&&window.scrollTo(0,0))},nigelgame.Screen.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},nigelgame.Screen.prototype.fill=function(a,b){a instanceof nigelgame.Rect||(a=new nigelgame.Rect(a));var c=this.context.fillStyle;this.context.fillStyle=b,this.context.fillRect(a.leftFor(this)*this.drawScale,a.topFor(this)*this.drawScale,a.width*this.drawScale,a.height*this.drawScale),this.context.fillStyle=c},nigelgame.Screen.prototype.drawSprite=function(a,b,c){if(a instanceof nigelgame.Sheet)a=a.getSprite();else if(!a.sheet||!a.rect)throw"invalid sprite.";b instanceof nigelgame.Point||(b=new nigelgame.Point(b)),anchor=c&&c.anchor||{},anchor.x=anchor.x||0,anchor.y=anchor.y||0;var d=b.xFor(this)+this.width/2-(anchor.x+1)/2*a.rect.width,e=b.yFor(this)+this.height/2-(anchor.y+1)/2*a.rect.height;this.context.drawImage(a.sheet.img,a.rect.left,a.rect.top,a.rect.width,a.rect.height,d*this.drawScale,e*this.drawScale,a.rect.width*this.drawScale,a.rect.height*this.drawScale)},nigelgame.Screen.prototype.drawString=function(a,b,c,d){if("string"!=typeof a&&(a+=""),!(b instanceof nigelgame.Sheet))throw"invalid font in drawString.";c instanceof nigelgame.Point||(c=new nigelgame.Point(c)),c=c||new nigelgame.Point({x:0,y:0}),d=d||{},d.anchor=d.anchor||{},d.anchor.x=d.anchor.x||0,d.anchor.y=d.anchor.y||0;var e;if(d.cols){e=[];for(var f=a,g=0;f.length>0&&!(g>=d.rows);++g)e.push(f.substr(0,Math.min(f.indexOf("\n"),d.cols))),f=f.substr(Math.min(f.indexOf("\n")+1,d.cols))}else e=a.split("\n");var h=0;e.forEach(function(a){a.length>h&&(h=a.length)});var i=0;if("left"===d.align||void 0===d.align)i=0;else if("center"===d.align)i=.5;else{if("right"!==d.align)throw"unknown text alignment: "+d.align;i=1}for(var j=c.translate({x:-h*b.spriteWidth*(d.anchor.x+1)/2,y:-e.length*b.spriteHeight*(d.anchor.y+1)/2}),g=0;g<e.length;++g)for(var k=Math.floor((h-e[g].length)*i),l=j.translate({x:k*b.spriteWidth,y:g*b.spriteHeight}),m=0;m<e[g].length;++m){var n=e[g].charCodeAt(m)-32;this.drawSprite(b.getSprite(n),l,{anchor:{x:-1,y:-1}}),l=l.translate({x:b.spriteWidth})}},nigelgame.Screen.prototype.drawBox=function(a,b,c){b instanceof nigelgame.Rect||(b=new nigelgame.Rect(b)),c=c||{},c.anchor=c.anchor||{},c.anchor.x=c.anchor.x||0,c.anchor.y=c.anchor.y||0;for(var d=b.point.translate({x:-b.width*(c.anchor.x+1)/2,y:-b.height*(c.anchor.y+1)/2}),e={anchor:{x:-1,y:-1}},f=a.spriteWidth,g=f;g<=b.width-f;g+=f)this.drawSprite(a.getSprite({row:0,col:1}),d.translate({x:g,y:0}),e),this.drawSprite(a.getSprite({row:2,col:1}),d.translate({x:g,y:b.height-a.spriteHeight}),e);for(var f=a.spriteHeight,g=f;g<=b.height-f;g+=f)this.drawSprite(a.getSprite({row:1,col:0}),d.translate({x:0,y:g}),e),this.drawSprite(a.getSprite({row:1,col:2}),d.translate({x:b.width-a.spriteWidth,y:g}),e);this.drawSprite(a.getSprite({row:0,col:0}),d,e),this.drawSprite(a.getSprite({row:0,col:2}),d.translate({x:b.width-a.spriteWidth}),e),this.drawSprite(a.getSprite({row:2,col:0}),d.translate({y:b.height-a.spriteHeight}),e),this.drawSprite(a.getSprite({row:2,col:2}),d.translate({x:b.width-a.spriteWidth,y:b.height-a.spriteHeight}),e);var h=b.resize({top:-8,bottom:-8,left:-8,right:-8});c&&c.color&&this.fill(h,c.color)},nigelgame.sheets={},nigelgame.loadImages=function(a,b){function c(a){function c(){nigelgame.sheets[a.alias]=new nigelgame.Sheet(a.alias,f,a.src,a.spriteWidth,a.spriteHeight),++e,e>=d&&b()}var f=new Image;f.onload=c,f.onerror=function(){throw"Failed to load image "+a.src},f.src=a.src,++d}for(var d=0,e=0,f=0;f<a.length;++f){if(!a[f].src)throw"missing source image";if(!a[f].alias)throw"missing alias";if(nigelgame.sheets[a[f].alias]){var g=nigelgame.sheets[a[f].alias];if(g.src===a[f].src)continue;throw"Sheet already defined with alias "+g.alias+"("+g.src+", "+a[f].src+")"}c(a[f])}0===d&&b()},nigelgame.Sheet=function(a,b,c,d,e){this.alias=a,this.img=b,this.src=c,this.width=b.width,this.height=b.height,this.spriteWidth=d||this.width,this.spriteHeight=e||this.height,this.numCols=Math.floor(this.width/this.spriteWidth),this.numRows=Math.floor(this.height/this.spriteHeight),this.numSprites=this.numCols*this.numRows},nigelgame.Sheet.prototype.getSprite=function(a){return new nigelgame.Sprite(this,a)},nigelgame.Sprite=function(a,b){"number"==typeof b&&b%1===0&&(b={col:b%a.numCols,row:Math.floor(b/a.numCols)});var c=void 0!==b?void 0!==b.x?b.x:b.col?b.col*a.spriteWidth:0:0,d=void 0!==b?void 0!==b.y?b.y:b.row?b.row*a.spriteHeight:0:0,e=void 0!==b?void 0!==b.width?b.width:void 0!==b.col?a.spriteWidth:a.width-c:a.width-c,f=void 0!==b?void 0!==b.height?b.height:void 0!==b.row?a.spriteHeight:a.height-d:a.height-d;this.sheet=a,this.rect=new nigelgame.Rect({left:c,top:d,width:e,height:f})};
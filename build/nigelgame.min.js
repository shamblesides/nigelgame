var nigelgame={};nigelgame.start=function(a){function b(){a.keyBinds&&(a.element.addEventListener("keydown",d,!1),a.element.addEventListener("keyup",e,!1)),a.useTouch&&(a.element.addEventListener("mousedown",f,!1),a.element.addEventListener("mouseup",h,!1),a.element.addEventListener("mousemove",g,!1)),window.requestAnimationFrame(c),window.setInterval(function(){n=!0},a.minFreq||33)}function c(){if(!o){if(o=!0,n){if(n=!1,m.nextView){var a=m.nextView;m.nextView=null,m=a,q=0}var b={total:p,view:q};m.update&&m.update(b),r.fitElement(),m.draw&&m.draw(r,b),++q,++p}o=!1,window.requestAnimationFrame(c)}}function d(b){var c=a.keyBinds[b.keyCode];void 0!==c&&(b.preventDefault(),k[c]||(k[c]=!0,m.keydown&&m.keydown(c)))}function e(b){var c=a.keyBinds[b.keyCode];void 0!==c&&k[c]&&(k[c]=!1,m.keyup&&m.keyup(c))}function f(a){var b=j(a);l.startPoint=b,l.lastPoint=b,m.touch&&m.touch(b,"mouse")}function g(a){if(l.startPoint){var b=j(a);b.startPoint=l.startPoint,b.lastPoint=l.lastPoint,b.lastPoint.startPoint=void 0,b.lastPoint.lastPoint=void 0,l.lastPoint=b,m.drag&&m.drag(b,"mouse")}}function h(a){if(m.release&&l.startPoint){var b=j(a);b.startPoint=l.startPoint,m.release(b,"mouse")}l.startPoint=null,l.lastPoint=null}function i(a,b){var c=r.width,d=r.height;return{fromScreenLeft:a,fromScreenTop:b,fromScreenRight:c-a,fromScreenBottom:d-b,fromCenterX:Math.round(a-c/2),fromCenterY:Math.round(b-d/2),hPercent:a/c*100,vPercent:b/d*100,inBounds:a>=0&&b>=0&&c>a&&d>b}}function j(b){var c=b.clientX-(a.element.clientLeft||0)-(a.element.offsetLeft||0),d=b.clientY-(a.element.clientTop||0)-(a.element.offsetTop||0);return i(Math.floor(c*r.width/(a.element.clientWidth||a.element.innerWidth)),Math.floor(d*r.height/(a.element.clientHeight||a.element.innerHeight)))}var k={},l={startPoint:null,lastPoint:null},m=a.view,n=!0,o=!1,p=0,q=0,r=new nigelgame.Screen(a.element,a.width||null,a.height||null);a.sheets&&a.sheets.length>0?nigelgame.loadImages(a.sheets,b):b()},window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,nigelgame.Point=function(a){this.x=a.x||0,this.y=a.y||0,this.xAnchor=a.xAnchor||0,this.yAnchor=a.yAnchor||0},nigelgame.Point.prototype.xFor=function(a){return Math.round(this.xAnchor*a.width/100+this.x)},nigelgame.Point.prototype.yFor=function(a){return Math.round(this.yAnchor*a.height/100+this.y)},nigelgame.Point.prototype.coordsFor=function(a){return{x:this.xFor(a),y:this.yFor(a)}},nigelgame.Point.prototype.translate=function(a){return new nigelgame.Point({x:this.x+(a.x||0),y:this.y+(a.y||0),xAnchor:this.xAnchor+(a.xAnchor||0),yAnchor:this.yAnchor+(a.yAnchor||0)})},nigelgame.Screen=function(a,b,c){this.element=a,this.minWidth=b||a.clientWidth||a.innerWidth,this.minHeight=c||a.clientHeight||a.innerWidth,this.width=void 0,this.height=void 0,this.drawScale=void 0,this.canvas=document.createElement("canvas"),this.canvas.style.display="block",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.backgroundColor="#000",this.context=this.canvas.getContext("2d");var d=a!==window?a:document.getElementsByTagName("body")[0];d.appendChild(this.canvas),this.element!==window&&this.element.tabIndex<0&&(this.element.tabIndex=0),this.fitElement()},nigelgame.Screen.prototype.fitElement=function(){var a=this.element.clientWidth||this.element.innerWidth,b=this.element.clientHeight||this.element.innerHeight;this.prevDims&&this.prevDims.width===a&&this.prevDims.height===b||(this.minWidth*b===this.minHeight*a?(this.width=this.minWidth,this.height=this.minHeight):this.minWidth*b<this.minHeight*a?(this.width=Math.floor(a/b*this.minHeight),this.height=this.minHeight):(this.width=this.minWidth,this.height=Math.floor(b/a*this.minWidth)),this.drawScale=Math.floor(Math.min(b/this.height,a/this.width)),this.drawScale<1&&(this.drawScale=1),this.canvas.width=this.width*this.drawScale,this.canvas.height=this.height*this.drawScale,this.context.webkitImageSmoothingEnabled=this.context.imageSmoothingEnabled=this.context.mozImageSmoothingEnabled=this.context.oImageSmoothingEnabled=!1,this.prevDims={height:b,width:a},this.element===window&&window.scrollTo(0,0))},nigelgame.Screen.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},nigelgame.Screen.prototype.fill=function(a,b,c,d){var e=this.context.fillStyle;this.context.fillStyle=d,this.context.fillRect(a.xFor(this)*this.drawScale,a.yFor(this)*this.drawScale,b*this.drawScale,c*this.drawScale),this.context.fillStyle=e},nigelgame.Screen.prototype.drawSprite=function(a,b,c){var d=a.getFrameRect(c);this.context.drawImage(a.img,d.left,d.top,d.width,d.height,b.xFor(this)*this.drawScale,b.yFor(this)*this.drawScale,d.width*this.drawScale,d.height*this.drawScale)},nigelgame.Screen.prototype.drawString=function(a,b,c,d,e){for(var f=((c||new nigelgame.Point({x:0,y:0})).coordsFor(this),0),g=0,h=0;h<a.length;++h)if("\n"===a.charAt(h)){if(++g,f=0,g>=e)break}else{if(f>=d&&(++g,f=0,g>=e))break;var i=a.charCodeAt(h)-32;this.drawSprite(b,c.translate({x:f*b.spriteWidth,y:g*b.spriteHeight}),i),++f}},nigelgame.Screen.prototype.drawStringBox=function(a,b,c,d,e,f,g){for(var h=f*d.spriteWidth+2*a.spriteWidth,i=g*d.spriteHeight+2*a.spriteHeight,j=a.spriteWidth,k=j;h-j>=k;k+=j)this.drawSprite(a,e.translate({x:k,y:0}),{row:0,col:1}),this.drawSprite(a,e.translate({x:k,y:i-a.spriteHeight}),{row:2,col:1});for(var j=a.spriteHeight,k=j;i-j>=k;k+=j)this.drawSprite(a,e.translate({x:0,y:k}),{row:1,col:0}),this.drawSprite(a,e.translate({x:h-a.spriteWidth,y:k}),{row:1,col:2});this.drawSprite(a,e,{row:0,col:0}),this.drawSprite(a,e.translate({x:h-a.spriteWidth}),{row:0,col:2}),this.drawSprite(a,e.translate({y:i-a.spriteHeight}),{row:2,col:0}),this.drawSprite(a,e.translate({x:h-a.spriteWidth,y:i-a.spriteHeight}),{row:2,col:2});var l=e.translate({x:a.spriteWidth,y:a.spriteHeight});this.fill(l,f*d.spriteWidth,g*d.spriteHeight,b),c&&this.drawString(c,d,l,f,g)},nigelgame.sheets={},nigelgame.loadImages=function(a,b){function c(a){function c(){nigelgame.sheets[a.alias]=new nigelgame.Sheet(a.alias,f,a.src,a.spriteWidth,a.spriteHeight),++e,e>=d&&b()}var f=new Image;f.onload=c,f.onerror=function(){throw"Failed to load image "+a.src},f.src=a.src,++d}for(var d=0,e=0,f=0;f<a.length;++f){if(!a[f].src)throw"missing source image";if(!a[f].alias)throw"missing alias";if(nigelgame.sheets[a[f].alias]){var g=nigelgame.sheets[a[f].alias];if(g.src===a[f].src)continue;throw"Sheet already defined with alias "+g.alias+"("+g.src+", "+a[f].src+")"}c(a[f])}0===d&&b()},nigelgame.Sheet=function(a,b,c,d,e){this.alias=a,this.img=b,this.src=c,this.width=b.width,this.height=b.height,this.spriteWidth=d||this.width,this.spriteHeight=e||this.height,this.numCols=Math.floor(this.width/this.spriteWidth),this.numRows=Math.floor(this.height/this.spriteHeight)},nigelgame.Sheet.prototype.getFrameRect=function(a){void 0!==a&&"number"==typeof a&&a%1===0&&(a={col:a%this.numCols,row:Math.floor(a/this.numCols)});var b=void 0!==a?void 0!==a.x?a.x:a.col?a.col*this.spriteWidth:0:0,c=void 0!==a?void 0!==a.y?a.y:a.row?a.row*this.spriteHeight:0:0,d=void 0!==a?void 0!==a.width?a.width:void 0!==a.col?this.spriteWidth:this.img.width-b:this.img.width-b,e=void 0!==a?void 0!==a.height?a.height:void 0!==a.row?this.spriteHeight:this.img.height-c:this.img.height-c;return{left:b,top:c,right:b+d,bottom:c+e,width:d,height:e}};
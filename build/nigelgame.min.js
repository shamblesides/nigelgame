var nigelgame={};nigelgame.start=function(a){function b(){a.keyBinds&&(a.element.addEventListener("keydown",d,!1),a.element.addEventListener("keyup",e,!1)),a.useTouch&&(a.element.addEventListener("mousedown",f,!1),a.element.addEventListener("mouseup",h,!1),a.element.addEventListener("mousemove",g,!1),a.element.addEventListener("touchstart",j,!1),a.element.addEventListener("touchmove",k,!1),a.element.addEventListener("touchend",l,!1)),window.requestAnimationFrame(c),window.setInterval(function(){r=!0},a.minFreq||33)}function c(){if(!s){if(s=!0,r){if(r=!1,q.nextView){var a=q.nextView;q.nextView=null,q=a,u=0}var b={total:t,view:u};q.update&&q.update(b),v.fitElement(),q.draw&&q.draw(v,b),++u,++t}s=!1,window.requestAnimationFrame(c)}}function d(b){var c=a.keyBinds[b.keyCode];void 0!==c&&(b.preventDefault(),n[c]||(n[c]=!0,q.keydown&&q.keydown(c)))}function e(b){var c=a.keyBinds[b.keyCode];void 0!==c&&n[c]&&(n[c]=!1,q.keyup&&q.keyup(c))}function f(a){var b=i(a);o.startPoint=b,o.lastPoint=b,q.touch&&q.touch({point:b,type:"mouse",screenRect:v.getRect()})}function g(a){if(o.startPoint){var b=i(a);q.drag&&q.drag({point:b,lastPoint:o.lastPoint,startPoint:o.startPoint,type:"mouse",screenRect:v.getRect()}),o.lastPoint=b}}function h(a){q.release&&o.startPoint&&q.release({point:i(a),startPoint:o.startPoint,type:"mouse",screenRect:v.getRect()}),o.startPoint=null,o.lastPoint=null}function i(b){var c=b.clientX-(a.element.clientLeft||0)-(a.element.offsetLeft||0),d=b.clientY-(a.element.clientTop||0)-(a.element.offsetTop||0),e=a.element.clientWidth||a.element.innerWidth,f=a.element.clientHeight||a.element.innerHeight;return new nigelgame.Point({x:Math.floor(c/e*v.width-v.width/2),y:Math.floor(d/f*v.height-v.height/2)})}function j(a){if(a.preventDefault(),a.touches.length===a.changedTouches.length){var b=m(a.changedTouches[0]);p={id:a.changedTouches[0].identifier,startPoint:b,lastPoint:b},q.touch&&q.touch({point:b,type:"touch",screenRect:v.getRect()})}}function k(a){if(a.preventDefault(),p.startPoint)for(var b=0;b<a.changedTouches.length;++b)if(a.changedTouches[b].identifier===p.id){var c=m(a.changedTouches[b]);return q.drag&&q.drag({point:c,lastPoint:p.lastPoint,startPoint:p.startPoint,type:"touch",screenRect:v.getRect()}),void(p.lastPoint=c)}}function l(a){if(a.preventDefault(),p.startPoint)for(var b=0;b<a.changedTouches.length;++b)if(a.changedTouches[b].identifier===p.id){if(0===a.targetTouches.length)q.release&&q.release({point:m(a.changedTouches[b]),startPoint:p.startPoint,type:"touch",screenRect:v.getRect()}),p.id=null,p.startPoint=null,p.lastPoint=null;else{var c=a.targetTouches[a.targetTouches.length-1],d=m(c);q.drag&&q.drag({point:d,lastPoint:p.lastPoint,startPoint:p.startPoint,type:"touch",screenRect:v.getRect()}),p.id=c.identifier,p.lastPoint=d}return}}function m(b){var c=b.clientX-(a.element.clientLeft||0)-(a.element.offsetLeft||0),d=b.clientY-(a.element.clientTop||0)-(a.element.offsetTop||0),e=a.element.clientWidth||a.element.innerWidth,f=a.element.clientHeight||a.element.innerHeight;return new nigelgame.Point({x:Math.floor(c/e*v.width-v.width/2),y:Math.floor(d/f*v.height-v.height/2)})}var n={},o={startPoint:null,lastPoint:null},p={id:null,startPoint:null,lastPoint:null},q=a.view,r=!0,s=!1,t=0,u=0,v=new nigelgame.Screen(a.element,a.width||null,a.height||null);a.sheets&&a.sheets.length>0?nigelgame.loadImages(a.sheets,b):b()},window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,Math.sign=function(a){return(a=parseFloat(a))?a>0?1:-1:a},nigelgame.Point=function(a){this.x=a.x||0,this.y=a.y||0,this.xAnchor=a.xAnchor||0,this.yAnchor=a.yAnchor||0},nigelgame.Point.prototype.xFor=function(a){return this.xAnchor*a.width/2+this.x},nigelgame.Point.prototype.yFor=function(a){return this.yAnchor*a.height/2+this.y},nigelgame.Point.prototype.translate=function(a){return new nigelgame.Point({x:this.x+(a.x||0),y:this.y+(a.y||0),xAnchor:this.xAnchor+(a.xAnchor||0),yAnchor:this.yAnchor+(a.yAnchor||0)})},nigelgame.Rect=function(a){var b=0;if((void 0!==a.left||void 0!==a.leftAnchor)&&++b,(void 0!==a.right||void 0!==a.rightAnchor)&&++b,(void 0!==a.width||void 0!==a.widthPerc)&&++b,2>b)throw"Horizontal boundaries are not well defined.";if(b>2)throw"Too many arguments for horizontal boundaries.";var c=0;if((void 0!==a.top||void 0!==a.topAnchor)&&++c,(void 0!==a.bottom||void 0!==a.bottomAnchor)&&++c,(void 0!==a.height||void 0!==a.heightPerc)&&++c,2>c)throw"Vertical boundaries are not well defined.";if(c>2)throw"Too many arguments for vertical boundaries.";this.left=void 0!==a.left||void 0!==a.leftAnchor?a.left||a.right||0:(a.right||0)-(a.width||0),this.right=void 0!==a.right||void 0!==a.rightAnchor?a.right||a.left||0:(a.left||0)+(a.width||0),this.top=void 0!==a.top||void 0!==a.topAnchor?a.top||a.bottom||0:(a.bottom||0)-(a.height||0),this.bottom=void 0!==a.bottom||void 0!==a.bottomAnchor?a.bottom||a.top||0:(a.top||0)+(a.height||0),this.leftAnchor=void 0!==a.leftAnchor||void 0!==a.left?a.leftAnchor||a.rightAnchor||0:(a.rightAnchor||0)-(2*a.widthPerc||0),this.rightAnchor=void 0!==a.rightAnchor||void 0!==a.right?a.rightAnchor||a.leftAnchor||0:(a.leftAnchor||0)+(2*a.widthPerc||0),this.topAnchor=void 0!==a.topAnchor||void 0!==a.left?a.topAnchor||a.bottomAnchor||0:(a.bottomAnchor||0)-(2*a.heightPerc||0),this.bottomAnchor=void 0!==a.bottomAnchor||void 0!==a.right?a.bottomAnchor||a.topAnchor||0:(a.topAnchor||0)+(2*a.heightPerc||0),this.width=this.right-this.left,this.height=this.bottom-this.top,this.widthPerc=(this.rightAnchor-this.leftAnchor)/2,this.heightPerc=(this.bottomAnchor-this.topAnchor)/2},nigelgame.Rect.prototype.leftFor=function(a){return this.left+this.leftAnchor*a.width/2},nigelgame.Rect.prototype.rightFor=function(a){return this.right+this.rightAnchor*a.width/2},nigelgame.Rect.prototype.topFor=function(a){return this.top+this.topAnchor*a.height/2},nigelgame.Rect.prototype.bottomFor=function(a){return this.bottom+this.bottomAnchor*a.height/2},nigelgame.Rect.prototype.widthFor=function(a){return this.width+this.widthPerc*a.width},nigelgame.Rect.prototype.heightFor=function(a){return this.height+this.heightPerc*a.height},nigelgame.Rect.prototype.contains=function(a,b){a instanceof nigelgame.Point||(a=new nigelgame.Point(a));var c=a.xFor(b),d=a.yFor(b);return c>=this.leftFor(b)&&c<=this.rightFor(b)&&d>=this.topFor(b)&&d<=this.bottomFor(b)},nigelgame.Rect.prototype.pointIn=function(a){return a instanceof nigelgame.Point||(a=new nigelgame.Point(a)),new nigelgame.Point({x:this.left+this.width*(a.xAnchor+1)/2+a.x,y:this.top+this.height*(a.yAnchor+1)/2+a.y,xAnchor:this.leftAnchor+2*this.widthPerc*(a.xAnchor+1)/2,yAnchor:this.topAnchor+2*this.heightPerc*(a.yAnchor+1)/2})},nigelgame.Screen=function(a,b,c){this.element=a,this.minWidth=b||a.clientWidth||a.innerWidth,this.minHeight=c||a.clientHeight||a.innerWidth,this.width=void 0,this.height=void 0,this.drawScale=void 0,this.canvas=document.createElement("canvas"),this.canvas.style.display="block",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.backgroundColor="#000",this.context=this.canvas.getContext("2d");var d=a!==window?a:document.getElementsByTagName("body")[0];d.appendChild(this.canvas),this.element!==window&&this.element.tabIndex<0&&(this.element.tabIndex=0)},nigelgame.Screen.prototype.fitElement=function(){var a=this.element.clientWidth||this.element.innerWidth,b=this.element.clientHeight||this.element.innerHeight;this.wasResized=!this.prevDims||this.prevDims.width!==a||this.prevDims.height!==b,this.wasResized&&(this.minWidth*b===this.minHeight*a?(this.width=this.minWidth,this.height=this.minHeight):this.minWidth*b<this.minHeight*a?(this.width=Math.floor(a/b*this.minHeight),this.height=this.minHeight):(this.width=this.minWidth,this.height=Math.floor(b/a*this.minWidth)),this.drawScale=Math.floor(Math.min(b/this.height,a/this.width)),this.drawScale<1&&(this.drawScale=1),this.canvas.width=this.width*this.drawScale,this.canvas.height=this.height*this.drawScale,this.context.webkitImageSmoothingEnabled=this.context.imageSmoothingEnabled=this.context.mozImageSmoothingEnabled=this.context.oImageSmoothingEnabled=!1,this.prevDims={height:b,width:a},this.element===window&&window.scrollTo(0,0))},nigelgame.Screen.prototype.getRect=function(){return new nigelgame.Rect({left:-this.width/2,top:-this.height/2,width:this.width,height:this.height})},nigelgame.Screen.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},nigelgame.Screen.prototype.fill=function(a,b){b instanceof nigelgame.Rect||(b=new nigelgame.Rect(b));var c=this.context.fillStyle;this.context.fillStyle=a,this.context.fillRect(Math.round(b.leftFor(this)+this.width/2)*this.drawScale,Math.round(b.topFor(this)+this.height/2)*this.drawScale,Math.round(b.widthFor(this))*this.drawScale,Math.round(b.heightFor(this))*this.drawScale),this.context.fillStyle=c},nigelgame.Screen.prototype.drawSprite=function(a,b,c){if(a instanceof nigelgame.Sheet)a=a.getSprite();else if(!a.sheet||!a.rect)throw"invalid sprite.";b instanceof nigelgame.Point||(b=new nigelgame.Point(b)),anchor=c&&c.anchor||{},anchor.x=anchor.x||0,anchor.y=anchor.y||0;var d=b.xFor(this)+this.width/2-(anchor.x+1)/2*a.rect.width,e=b.yFor(this)+this.height/2-(anchor.y+1)/2*a.rect.height;this.context.drawImage(a.sheet.img,a.rect.leftFor(a.sheet),a.rect.topFor(a.sheet),a.rect.widthFor(a.sheet),a.rect.heightFor(a.sheet),Math.round(d)*this.drawScale,Math.round(e)*this.drawScale,a.rect.widthFor(a.sheet)*this.drawScale,a.rect.heightFor(a.sheet)*this.drawScale)},nigelgame.Screen.prototype.drawString=function(a,b,c,d){var e;if(a instanceof nigelgame.Nstring?e=a:("string"!=typeof a&&(a+=""),e=new nigelgame.Nstring(a,d.cols,d.rows)),!(b instanceof nigelgame.Sheet))throw"invalid font in drawString.";c instanceof nigelgame.Point||(c=new nigelgame.Point(c)),c=c||new nigelgame.Point({x:0,y:0}),d=d||{};var f=d.anchor?{x:d.anchor.x||0,y:d.anchor.y||0}:{x:0,y:0},g=0;if("left"===d.align||void 0===d.align)g=0;else if("center"===d.align)g=.5;else{if("right"!==d.align)throw"unknown text alignment: "+d.align;g=1}for(var h=c.translate({x:-e.maxcol*b.spriteWidth*(f.x+1)/2,y:-e.lines.length*b.spriteHeight*(f.y+1)/2}),i=0;i<e.lines.length;++i)for(var j=Math.floor((e.maxcol-e.lines[i].length)*g),k=h.translate({x:j*b.spriteWidth,y:i*b.spriteHeight}),l=0;l<e.lines[i].length;++l){var m=e.lines[i].charCodeAt(l)-32;this.drawSprite(b.getSprite(m),k,{anchor:{x:-1,y:-1}}),k=k.translate({x:b.spriteWidth})}},nigelgame.Screen.prototype.drawBox=function(a,b,c){b instanceof nigelgame.Rect||(b=new nigelgame.Rect(b)),c&&this.fill(c,b);for(var d=b.pointIn({xAnchor:-1,yAnchor:-1}),e=a.spriteWidth,f=e;f<b.widthFor(this)-e;f+=e)this.drawSprite(a.getSprite(1),d.translate({x:f}),{anchor:{x:-1,y:-1}}),this.drawSprite(a.getSprite(7),d.translate({x:f,y:b.heightFor(this)}),{anchor:{x:-1,y:1}});for(var e=a.spriteHeight,f=e;f<b.heightFor(this)-e;f+=e)this.drawSprite(a.getSprite(3),d.translate({y:f}),{anchor:{x:-1,y:-1}}),this.drawSprite(a.getSprite(5),d.translate({x:b.widthFor(this),y:f}),{anchor:{x:1,y:-1}});this.drawSprite(a.getSprite(0),b.pointIn({xAnchor:-1,yAnchor:-1}),{anchor:{x:-1,y:-1}}),this.drawSprite(a.getSprite(2),b.pointIn({xAnchor:1,yAnchor:-1}),{anchor:{x:1,y:-1}}),this.drawSprite(a.getSprite(6),b.pointIn({xAnchor:-1,yAnchor:1}),{anchor:{x:-1,y:1}}),this.drawSprite(a.getSprite(8),b.pointIn({xAnchor:1,yAnchor:1}),{anchor:{x:1,y:1}})},nigelgame.Screen.prototype.drawStringBox=function(a,b,c,d,e){d instanceof nigelgame.Point||(d=new nigelgame.Point(d)),e=e||{};var f=e.anchor?{x:e.anchor.x||0,y:e.anchor.y||0}:{x:0,y:0},g=new nigelgame.Nstring(a,e.cols,e.rows),h=(e.cols||g.maxcol)*b.spriteWidth+2*c.spriteWidth,i=(e.rows||g.rows)*b.spriteHeight+2*c.spriteHeight,j={left:d.x-h*(f.x+1)/2,width:h,top:d.y-i*(f.y+1)/2,height:i,leftAnchor:d.xAnchor,topAnchor:d.yAnchor};this.drawBox(c,j,e.color),this.drawString(a,b,d.translate({x:-c.spriteWidth*f.x,y:-c.spriteHeight*f.y}),{cols:e.cols,rows:e.rows,anchor:f,align:e.align})},nigelgame.sheets={},nigelgame.loadImages=function(a,b){function c(a){function c(){nigelgame.sheets[a.alias]=new nigelgame.Sheet(a.alias,f,a.src,a.spriteWidth,a.spriteHeight),++e,e>=d&&b()}var f=new Image;f.onload=c,f.onerror=function(){throw"Failed to load image "+a.src},f.src=a.src,++d}for(var d=0,e=0,f=0;f<a.length;++f){if(!a[f].src)throw"missing source image";if(!a[f].alias)throw"missing alias";if(nigelgame.sheets[a[f].alias]){var g=nigelgame.sheets[a[f].alias];if(g.src===a[f].src)continue;throw"Sheet already defined with alias "+g.alias+"("+g.src+", "+a[f].src+")"}c(a[f])}0===d&&b()},nigelgame.Sheet=function(a,b,c,d,e){this.alias=a,this.img=b,this.src=c,this.width=b.width,this.height=b.height,this.spriteWidth=d||this.width,this.spriteHeight=e||this.height,this.numCols=Math.floor(this.width/this.spriteWidth),this.numRows=Math.floor(this.height/this.spriteHeight),this.numSprites=this.numCols*this.numRows},nigelgame.Sheet.prototype.getSprite=function(a){return new nigelgame.Sprite(this,a)},nigelgame.Sprite=function(a,b){"number"==typeof b&&b%1===0&&(b={col:b%a.numCols,row:Math.floor(b/a.numCols)});var c=void 0!==b?void 0!==b.x?b.x:b.col?b.col*a.spriteWidth:0:0,d=void 0!==b?void 0!==b.y?b.y:b.row?b.row*a.spriteHeight:0:0,e=void 0!==b?void 0!==b.width?b.width:void 0!==b.col?a.spriteWidth:a.width-c:a.width-c,f=void 0!==b?void 0!==b.height?b.height:void 0!==b.row?a.spriteHeight:a.height-d:a.height-d;this.sheet=a,this.rect=new nigelgame.Rect({left:c,top:d,width:e,height:f})},nigelgame.Nstring=function(a,b,c){if(b){this.lines=[];for(var d=a,e=0;d.length>0&&!(e>=c);++e)this.lines.push(d.substr(0,Math.min(d.indexOf("\n"),b))),d=d.substr(Math.min(d.indexOf("\n")+1,b))}else this.lines=a.split("\n");var f=0;this.lines.forEach(function(a){a.length>f&&(f=a.length)}),this.maxcol=f,this.rows=this.lines.length};
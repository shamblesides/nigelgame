var nigelgame={};nigelgame.start=function(a){function b(){a.json&&a.json.length>0?nigelgame.loadJSON(a.json,c):c()}function c(){a.keyBinds&&(a.element.addEventListener("keydown",f,!1),a.element.addEventListener("keyup",g,!1)),a.useKeyboard&&a.element.addEventListener("keypress",h,!1),a.useTouch&&(a.element.addEventListener("mousedown",i,!1),a.element.addEventListener("mouseup",k,!1),a.element.addEventListener("mousemove",j,!1),a.element.addEventListener("touchstart",n,!1),a.element.addEventListener("touchmove",o,!1),a.element.addEventListener("touchend",p,!1),a.element.addEventListener("contextmenu",function(a){return a.preventDefault(),!1},!1)),r=new a.view,a.framerate&&window.setInterval(function(){v=!0},a.framerate),window.requestAnimationFrame(d)}function d(){w||(w=!0,(!a.framerate||v)&&(v=!1,a.frameskip?(++z,z>a.frameskip&&(z=0,e())):e()),w=!1,window.requestAnimationFrame(d))}function e(){if(r.nextView){var a=r.nextView;r.nextView=null,r=a,y=0}var b={total:x,view:y};r.update&&r.update(b),A.fitElement(),r.draw&&r.draw(A,b),++y,++x}function f(b){a.useKeyboard||b.preventDefault();var c=a.keyBinds[b.keyCode];return void 0===c?!0:!s[c]&&(s[c]=!0,r.buttondown)?r.buttondown(c):void 0}function g(b){var c=a.keyBinds[b.keyCode];return void 0===c?!0:s[c]&&(s[c]=!1,r.buttonup)?r.buttonup(c):void 0}function h(a){(!r.keypress||r.keypress(a))&&a.preventDefault()}function i(a){var b=l(a);t.startPoint=b,t.lastPoint=b,t.button=m(a),r.touch&&r.touch({point:b,type:t.button,screenRect:A.getRect()})}function j(a){if(t.startPoint){var b=l(a);b.equals(t.lastPoint)||(r.drag&&r.drag({point:b,lastPoint:t.lastPoint,startPoint:t.startPoint,type:t.button,screenRect:A.getRect()}),t.lastPoint=b)}}function k(a){r.release&&t.startPoint&&t.button===m(a)&&r.release({point:l(a),startPoint:t.startPoint,type:t.button,screenRect:A.getRect()}),t.startPoint=null,t.lastPoint=null}function l(b){var c=b.clientX-(a.element.clientLeft||0)-(a.element.offsetLeft||0),d=b.clientY-(a.element.clientTop||0)-(a.element.offsetTop||0),e=a.element.clientWidth||a.element.innerWidth,f=a.element.clientHeight||a.element.innerHeight;return new nigelgame.Point({x:Math.floor(c/e*A.width-A.width/2),y:Math.floor(d/f*A.height-A.height/2)})}function m(a){return 2===a.button?"rightmouse":"mouse"}function n(a){if(a.preventDefault(),a.touches.length===a.changedTouches.length){var b=q(a.changedTouches[0]);u={id:a.changedTouches[0].identifier,startPoint:b,lastPoint:b},r.touch&&r.touch({point:b,type:"touch",screenRect:A.getRect()})}}function o(a){if(a.preventDefault(),u.startPoint)for(var b=0;b<a.changedTouches.length;++b)if(a.changedTouches[b].identifier===u.id){var c=q(a.changedTouches[b]);if(c.equals(u.lastPoint))return;return r.drag&&r.drag({point:c,lastPoint:u.lastPoint,startPoint:u.startPoint,type:"touch",screenRect:A.getRect()}),void(u.lastPoint=c)}}function p(a){if(a.preventDefault(),u.startPoint)for(var b=0;b<a.changedTouches.length;++b)if(a.changedTouches[b].identifier===u.id){if(0===a.targetTouches.length)r.release&&r.release({point:q(a.changedTouches[b]),startPoint:u.startPoint,type:"touch",screenRect:A.getRect()}),u.id=null,u.startPoint=null,u.lastPoint=null;else{var c=a.targetTouches[a.targetTouches.length-1],d=q(c);r.drag&&r.drag({point:d,lastPoint:u.lastPoint,startPoint:u.startPoint,type:"touch",screenRect:A.getRect()}),u.id=c.identifier,u.lastPoint=d}return}}function q(b){var c=b.clientX-(a.element.clientLeft||0)-(a.element.offsetLeft||0),d=b.clientY-(a.element.clientTop||0)-(a.element.offsetTop||0),e=a.element.clientWidth||a.element.innerWidth,f=a.element.clientHeight||a.element.innerHeight;return new nigelgame.Point({x:Math.floor(c/e*A.width-A.width/2),y:Math.floor(d/f*A.height-A.height/2)})}var r,s={},t={startPoint:null,lastPoint:null,button:null},u={id:null,startPoint:null,lastPoint:null},v=!0,w=!1,x=0,y=0,z=0,A=new nigelgame.Screen(a.element,a.scaleMode,a.width,a.height,a.scale);a.sheets&&a.sheets.length>0?nigelgame.loadImages(a.sheets,b):b()},window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,Math.sign=function(a){return(a=parseFloat(a))?a>0?1:-1:a},nigelgame.Point=function(a){this.x=a.x||0,this.y=a.y||0,this.xAnchor=a.xAnchor||0,this.yAnchor=a.yAnchor||0},nigelgame.Point.prototype.xFor=function(a){return this.xAnchor*a.width/2+this.x},nigelgame.Point.prototype.yFor=function(a){return this.yAnchor*a.height/2+this.y},nigelgame.Point.prototype.translate=function(a){return new nigelgame.Point({x:this.x+(a.x||0),y:this.y+(a.y||0),xAnchor:this.xAnchor+(a.xAnchor||0),yAnchor:this.yAnchor+(a.yAnchor||0)})},nigelgame.Point.prototype.untranslate=function(a){return new nigelgame.Point({x:this.x-(a.x||0),y:this.y-(a.y||0),xAnchor:this.xAnchor-(a.xAnchor||0),yAnchor:this.yAnchor-(a.yAnchor||0)})},nigelgame.Point.prototype.inverse=function(){return new nigelgame.Point({x:-this.x,y:-this.y,xAnchor:-this.xAnchor,yAnchor:-this.yAnchor})},nigelgame.Point.prototype.equals=function(a){return this.x==a.x&&this.y==a.y&&this.xAnchor==a.xAnchor&&this.yAnchor==a.yAnchor},nigelgame.Rect=function(a){var b=0,c=0,d=0;if((void 0!==a.left||void 0!==a.leftAnchor)&&(b=1),(void 0!==a.right||void 0!==a.rightAnchor)&&(c=1),(void 0!==a.width||void 0!==a.widthPerc)&&(d=1),2>b+c+d)throw"Horizontal boundaries are not well defined.";if(b+c+d>2)throw"Too many arguments for horizontal boundaries.";var e=0,f=0,g=0;if((void 0!==a.top||void 0!==a.topAnchor)&&(e=1),(void 0!==a.bottom||void 0!==a.bottomAnchor)&&(f=1),(void 0!==a.height||void 0!==a.heightPerc)&&(g=1),2>e+f+g)throw"Vertical boundaries are not well defined.";if(e+f+g>2)throw"Too many arguments for vertical boundaries.";this.left=b?void 0!==a.left?a.left:a.right||0:(a.right||0)-(a.width||0),this.right=c?void 0!==a.right?a.right:a.left||0:(a.left||0)+(a.width||0),this.top=e?void 0!==a.top?a.top:a.bottom||0:(a.bottom||0)-(a.height||0),this.bottom=f?void 0!==a.bottom?a.bottom:a.top||0:(a.top||0)+(a.height||0),this.leftAnchor=b?void 0!==a.leftAnchor?a.leftAnchor:a.rightAnchor||0:(a.rightAnchor||0)-(2*a.widthPerc||0),this.rightAnchor=c?void 0!==a.rightAnchor?a.rightAnchor:a.leftAnchor||0:(a.leftAnchor||0)+(2*a.widthPerc||0),this.topAnchor=e?void 0!==a.topAnchor?a.topAnchor:a.bottomAnchor||0:(a.bottomAnchor||0)-(2*a.heightPerc||0),this.bottomAnchor=f?void 0!==a.bottomAnchor?a.bottomAnchor:a.topAnchor||0:(a.topAnchor||0)+(2*a.heightPerc||0),this.width=this.right-this.left,this.height=this.bottom-this.top,this.widthPerc=(this.rightAnchor-this.leftAnchor)/2,this.heightPerc=(this.bottomAnchor-this.topAnchor)/2},nigelgame.Rect.prototype.leftFor=function(a){return this.left+this.leftAnchor*a.width/2},nigelgame.Rect.prototype.rightFor=function(a){return this.right+this.rightAnchor*a.width/2},nigelgame.Rect.prototype.topFor=function(a){return this.top+this.topAnchor*a.height/2},nigelgame.Rect.prototype.bottomFor=function(a){return this.bottom+this.bottomAnchor*a.height/2},nigelgame.Rect.prototype.widthFor=function(a){return this.width+this.widthPerc*a.width},nigelgame.Rect.prototype.heightFor=function(a){return this.height+this.heightPerc*a.height},nigelgame.Rect.prototype.expand=function(a){return new nigelgame.Rect({top:this.top-(a.top||0),bottom:this.bottom+(a.bottom||0),left:this.left-(a.left||0),right:this.right+(a.right||0),leftAnchor:this.leftAnchor-(a.leftAnchor||0),rightAnchor:this.rightAnchor+(a.rightAnchor||0),topAnchor:this.topAnchor-(a.topAnchor||0),bottomAnchor:this.bottomAnchor+(a.bottomAnchor||0)})},nigelgame.Rect.prototype.shrink=function(a){return new nigelgame.Rect({top:this.top+(a.top||0),bottom:this.bottom-(a.bottom||0),left:this.left+(a.left||0),right:this.right-(a.right||0),leftAnchor:this.leftAnchor+(a.leftAnchor||0),rightAnchor:this.rightAnchor-(a.rightAnchor||0),topAnchor:this.topAnchor+(a.topAnchor||0),bottomAnchor:this.bottomAnchor-(a.bottomAnchor||0)})},nigelgame.Rect.prototype.translate=function(a){return new nigelgame.Rect({top:this.top+(a.y||0),bottom:this.bottom+(a.y||0),left:this.left+(a.x||0),right:this.right+(a.x||0),leftAnchor:this.leftAnchor+(a.xAnchor||0),rightAnchor:this.rightAnchor+(a.xAnchor||0),topAnchor:this.topAnchor+(a.yAnchor||0),bottomAnchor:this.bottomAnchor+(a.yAnchor||0)})},nigelgame.Rect.prototype.untranslate=function(a){return new nigelgame.Rect({top:this.top-(a.y||0),bottom:this.bottom-(a.y||0),left:this.left-(a.x||0),right:this.right-(a.x||0),leftAnchor:this.leftAnchor-(a.xAnchor||0),rightAnchor:this.rightAnchor-(a.xAnchor||0),topAnchor:this.topAnchor-(a.yAnchor||0),bottomAnchor:this.bottomAnchor-(a.yAnchor||0)})},nigelgame.Rect.prototype.contains=function(a,b){a instanceof nigelgame.Point||(a=new nigelgame.Point(a));var c=a.xFor(b),d=a.yFor(b);return c>=this.leftFor(b)&&c<=this.rightFor(b)&&d>=this.topFor(b)&&d<=this.bottomFor(b)},nigelgame.Rect.prototype.pointIn=function(a){return a instanceof nigelgame.Point||(a=new nigelgame.Point(a)),new nigelgame.Point({x:this.left+this.width*(a.xAnchor+1)/2+a.x,y:this.top+this.height*(a.yAnchor+1)/2+a.y,xAnchor:this.leftAnchor+this.widthPerc*(a.xAnchor+1),yAnchor:this.topAnchor+this.heightPerc*(a.yAnchor+1)})},nigelgame.Rect.prototype.pointOut=function(a){return a instanceof nigelgame.Point||(a=new nigelgame.Point(a)),new nigelgame.Point({x:a.x-this.left-this.width*(a.xAnchor+1)/2,y:a.y-this.top-this.height*(a.yAnchor+1)/2,xAnchor:(a.xAnchor-this.leftAnchor)/this.widthPerc-1,yAnchor:(a.yAnchor-this.topAnchor)/this.heightPerc-1})},nigelgame.Rect.prototype.rectIn=function(a){return a instanceof nigelgame.Rect||(a=new nigelgame.Rect(a)),new nigelgame.Rect({left:this.left+this.width*(a.leftAnchor+1)/2+a.left,right:this.left+this.width*(a.rightAnchor+1)/2+a.right,top:this.top+this.height*(a.topAnchor+1)/2+a.top,bottom:this.top+this.height*(a.bottomAnchor+1)/2+a.bottom,leftAnchor:this.leftAnchor+2*this.widthPerc*(a.leftAnchor+1)/2,rightAnchor:this.leftAnchor+2*this.widthPerc*(a.rightAnchor+1)/2,topAnchor:this.topAnchor+2*this.heightPerc*(a.topAnchor+1)/2,bottomAnchor:this.topAnchor+2*this.heightPerc*(a.bottomAnchor+1)/2})},nigelgame.Point.prototype.rectFrom=function(a){var b={x:a.anchor&&a.anchor.x||0,y:a.anchor&&a.anchor.y||0};return new nigelgame.Rect({width:a.width,height:a.height,left:this.x-a.width*(b.x+1)/2,top:this.y-a.height*(b.y+1)/2,leftAnchor:this.xAnchor,topAnchor:this.yAnchor})},nigelgame.json={},nigelgame.loadJSON=function(a,b){function c(a){function c(){nigelgame.json[a.alias]=JSON.parse(f.response),++e,e>=d&&b()}var f=new XMLHttpRequest;f.open("GET",a.src),f.overrideMimeType("application/json"),f.onloadend=c,f.onerror=function(){throw"Error loading JSON file: "+a.src},f.ontimeout=function(){throw"Request timed out: "+a.src},f.send(),++d}for(var d=0,e=0,f=0;f<a.length;++f){if(!a[f].src)throw"missing json source filename";if(!a[f].alias)throw"missing alias";if(nigelgame.json[a[f].alias]){var g=nigelgame.sheets[a[f].alias];throw"Duplicate alias for "+g.alias+"("+g.src+", "+a[f].src+")"}c(a[f])}0===d&&b()},nigelgame.Screen=function(a,b,c,d,e){if(b){if(-1===nigelgame.Screen.MODES.indexOf(b.toLowerCase()))throw"unsupported screen mode: "+b}else b="scale-adapt";b=b.toLowerCase(),c=c||a.clientWidth||a.innerWidth,d=d||a.clientHeight||a.innerWidth,Object.defineProperty(this,"element",{get:function(){return a}}),Object.defineProperty(this,"mode",{get:function(){return b}}),Object.defineProperty(this,"minWidth",{get:function(){return c}}),Object.defineProperty(this,"minHeight",{get:function(){return c}}),this.width=void 0,this.height=void 0,this.drawScale=e||1;var f=new nigelgame.Rect({leftAnchor:-1,rightAnchor:1,topAnchor:-1,bottomAnchor:1});Object.defineProperty(this,"subRect",{get:function(){return f}}),this.canvas=document.createElement("canvas"),this.canvas.style.display="block",this.canvas.style.width="100%",this.canvas.style.height="100%",this.context=this.canvas.getContext("2d"),(a!==window?a:document.getElementsByTagName("body")[0]).appendChild(this.canvas),this.element!==window&&this.element.tabIndex<0&&(this.element.tabIndex=0)},nigelgame.Screen.MODES=["none","adapt","scale-adapt"],nigelgame.Panel=function(a,b){this.subRect=a.subRect.rectIn(b),this.screen=a.screen||a,Object.defineProperty(this,"canvas",{get:function(){return this.screen.canvas}}),Object.defineProperty(this,"width",{get:function(){return this.subRect.widthFor(a)}}),Object.defineProperty(this,"height",{get:function(){return this.subRect.heightFor(a)}})},nigelgame.Screen.prototype.panel=function(a){return new nigelgame.Panel(this,a)},nigelgame.Screen.prototype.fitElement=function(){var a=this.element.clientWidth||this.element.innerWidth,b=this.element.clientHeight||this.element.innerHeight;this.wasResized=!this.prevDims||this.prevDims.width!==a||this.prevDims.height!==b,this.wasResized&&("none"===this.mode?this.fitElementModeNone(a,b):"adapt"===this.mode?this.fitElementModeAdapt(a,b):"scale-adapt"===this.mode&&this.fitElementModeScaleAdapt(a,b),this.prevDims={height:b,width:a})},nigelgame.Screen.prototype.fitElementModeNone=function(){this.prevDims||(this.canvas.width=(this.width=this.minWidth)*this.drawScale,this.canvas.height=(this.height=this.minHeight)*this.drawScale,this.drawScale>1&&this.crispy())},nigelgame.Screen.prototype.fitElementModeAdapt=function(a,b){this.canvas.width=(this.width=Math.floor(a/this.drawScale))*this.drawScale,this.canvas.height=(this.height=Math.floor(b/this.drawScale))*this.drawScale,this.drawScale>1&&this.crispy()},nigelgame.Screen.prototype.fitElementModeScaleAdapt=function(a,b){this.minWidth*b===this.minHeight*a?(this.width=this.minWidth,this.height=this.minHeight):this.minWidth*b<this.minHeight*a?(this.width=Math.floor(a/b*this.minHeight),this.height=this.minHeight):(this.width=this.minWidth,this.height=Math.floor(b/a*this.minWidth)),this.drawScale=Math.floor(Math.min(b/this.height,a/this.width)),this.drawScale<1&&(this.drawScale=1),this.canvas.width=this.width*this.drawScale,this.canvas.height=this.height*this.drawScale,this.crispy(),this.element===window&&window.scrollTo(0,0)},nigelgame.Screen.prototype.crispy=function(){this.context.webkitImageSmoothingEnabled=this.context.imageSmoothingEnabled=this.context.mozImageSmoothingEnabled=this.context.oImageSmoothingEnabled=!1},nigelgame.Screen.prototype.getRect=function(){return new nigelgame.Rect({left:-this.width/2,top:-this.height/2,width:this.width,height:this.height})},nigelgame.Screen.prototype.clear=nigelgame.Panel.prototype.clear=function(a){if(!a&&!this.screen)return void this.context.clearRect(0,0,this.canvas.width,this.canvas.height);a||(a=this.subRect),a instanceof nigelgame.Rect||(a=new nigelgame.Rect(a));var b=this.screen||this,c=b.width/2,d=b.height/2,e=Math.round(a.widthFor(b)),f=Math.round(a.heightFor(b)),g=Math.round(a.leftFor(b)+c),h=Math.round(a.topFor(b)+d),i=Math.round(this.subRect.leftFor(b)+c),j=Math.round(this.subRect.topFor(b)+d);i>g&&(e-=i-g,g=i),j>h&&(f-=j-h,h=j);var k=Math.round(this.subRect.rightFor(b)+c),l=Math.round(this.subRect.bottomFor(b)+d);g+e>k&&(e=k-g),h+f>l&&(f=l-h),0>=e||0>=f||b.context.clearRect(g*b.drawScale,h*b.drawScale,e*b.drawScale,f*b.drawScale)},nigelgame.Screen.prototype.fill=nigelgame.Panel.prototype.fill=function(a,b){!b||b instanceof nigelgame.Rect||(b=new nigelgame.Rect(b));var c=this.screen||this,d=c.context.fillStyle;c.context.fillStyle=a,b=b?this.subRect.rectIn(b):this.subRect;var e=c.width/2,f=c.height/2,g=Math.round(b.widthFor(c)),h=Math.round(b.heightFor(c)),i=Math.round(b.leftFor(c)+e),j=Math.round(b.topFor(c)+f),k=Math.round(this.subRect.leftFor(c)+e),l=Math.round(this.subRect.topFor(c)+f);k>i&&(g-=k-i,i=k),l>j&&(h-=l-j,j=l);var m=Math.round(this.subRect.rightFor(c)+e),n=Math.round(this.subRect.bottomFor(c)+f);i+g>m&&(g=m-i),j+h>n&&(h=n-j),0>=g||0>=h||(c.context.fillRect(i*c.drawScale,j*c.drawScale,g*c.drawScale,h*c.drawScale),c.context.fillStyle=d)},nigelgame.Screen.prototype.drawSprite=nigelgame.Panel.prototype.drawSprite=function(a,b,c){if(a instanceof nigelgame.Sheet)a=a.getSprite();else if(!a.sheet||!a.rect)throw"invalid sprite.";var d=c&&c.anchor||{};void 0===d.x&&(d.x=b.xAnchor||0),void 0===d.y&&(d.y=b.yAnchor||0),b=this.subRect.pointIn(b);var e=this.screen||this,f=e.width/2,g=e.height/2,h=a.rect.widthFor(a.sheet),i=a.rect.heightFor(a.sheet),j=Math.round(b.xFor(e)+f-(d.x+1)/2*h),k=Math.round(b.yFor(e)+g-(d.y+1)/2*i),l=Math.round(this.subRect.leftFor(e)+f),m=Math.round(this.subRect.topFor(e)+g),n=0,o=0;l>j&&(n=l-j,h-=n,j=l),m>k&&(o=m-k,i-=o,k=m);var p=Math.round(this.subRect.rightFor(e)+f),q=Math.round(this.subRect.bottomFor(e)+g);j+h>p&&(h=p-j),k+i>q&&(i=q-k),0>=h||0>=i||e.context.drawImage(a.sheet.img,a.rect.leftFor(a.sheet)+n,a.rect.topFor(a.sheet)+o,h,i,j*e.drawScale,k*e.drawScale,h*e.drawScale,i*e.drawScale)},nigelgame.Screen.prototype.drawString=nigelgame.Panel.prototype.drawString=function(a,b,c,d){if(!(b instanceof nigelgame.Sheet))throw"invalid font in drawString.";c instanceof nigelgame.Point||(c=new nigelgame.Point(c)),d=d||{},(d.cols||d.rows)&&(a=nigelgame.wrapString(a,d.cols,d.rows)),c=c||new nigelgame.Point({x:0,y:0});var e=d&&d.anchor||{};void 0===e.x&&(e.x=c.xAnchor||0),void 0===e.y&&(e.y=c.yAnchor||0);for(var f=a.split("\n"),g=0,h=0;h<f.length;++h)g=Math.max(f[h].length,g);var i=0;if(d&&d.align&&"left"!==d.align)if("center"===d.align)i=.5;else{if("right"!==d.align)throw"unknown text alignment: "+d.align;i=1}else i=0;for(var j=c.translate({x:-g*b.spriteWidth*(e.x+1)/2,y:-f.length*b.spriteHeight*(e.y+1)/2}),k=0;k<f.length;++k)for(var l=(g-f[k].length)*i,m=j.translate({x:l*b.spriteWidth,y:k*b.spriteHeight}),n=0;n<f[k].length;++n){var o=f[k].charCodeAt(n)-32;this.drawSprite(b.getSprite(o),m,{anchor:{x:-1,y:-1}}),m=m.translate({x:b.spriteWidth})}},nigelgame.Screen.prototype.drawBox=nigelgame.Panel.prototype.drawBox=function(a,b,c){b instanceof nigelgame.Rect||(b=new nigelgame.Rect(b)),c&&this.fill(c,b);for(var d=b.pointIn({xAnchor:-1,yAnchor:-1}),e=a.spriteWidth,f=e;f<b.widthFor(this)-e;f+=e)this.drawSprite(a.getSprite(1),d.translate({x:f}),{anchor:{x:-1,y:-1}}),this.drawSprite(a.getSprite(7),d.translate({x:f,y:b.heightFor(this)}),{anchor:{x:-1,y:1}});for(var e=a.spriteHeight,f=e;f<b.heightFor(this)-e;f+=e)this.drawSprite(a.getSprite(3),d.translate({y:f}),{anchor:{x:-1,y:-1}}),this.drawSprite(a.getSprite(5),d.translate({x:b.widthFor(this),y:f}),{anchor:{x:1,y:-1}});this.drawSprite(a.getSprite(0),b.pointIn({xAnchor:-1,yAnchor:-1}),{anchor:{x:-1,y:-1}}),this.drawSprite(a.getSprite(2),b.pointIn({xAnchor:1,yAnchor:-1}),{anchor:{x:1,y:-1}}),this.drawSprite(a.getSprite(6),b.pointIn({xAnchor:-1,yAnchor:1}),{anchor:{x:-1,y:1}}),this.drawSprite(a.getSprite(8),b.pointIn({xAnchor:1,yAnchor:1}),{anchor:{x:1,y:1}})},nigelgame.Screen.prototype.drawStringBox=nigelgame.Panel.prototype.drawStringBox=function(a,b,c,d,e){d instanceof nigelgame.Point||(d=new nigelgame.Point(d)),e=e||{};var f=e&&e.anchor||{};void 0===f.x&&(f.x=d.xAnchor||0),void 0===f.y&&(f.y=d.yAnchor||0);for(var g=a.split("\n"),h=0,i=0;i<g.length;++i)h=Math.max(g[i].length,h);var j=(e.cols||h)*b.spriteWidth+2*c.spriteWidth,k=(e.rows||g.length)*b.spriteHeight+2*c.spriteHeight,l=d.rectFrom({width:j,height:k,anchor:f});this.drawBox(c,l,e.color),this.drawString(a,b,d.translate({x:-c.spriteWidth*f.x,y:-c.spriteHeight*f.y}),{cols:e.cols,rows:e.rows,anchor:f,align:e.align})},nigelgame.sheets={},nigelgame.loadImages=function(a,b){function c(a){function c(){nigelgame.sheets[a.alias]=new nigelgame.Sheet(a.alias,f,a.src,a.spriteWidth,a.spriteHeight),++e,e>=d&&b()}var f=new Image;f.onload=c,f.onerror=function(){throw"Failed to load image "+a.src},f.src=a.src,++d}for(var d=0,e=0,f=0;f<a.length;++f){if(!a[f].src)throw"missing source image";if(!a[f].alias)throw"missing alias";if(nigelgame.sheets[a[f].alias]){var g=nigelgame.sheets[a[f].alias];if(g.src===a[f].src)continue;throw"Sheet already defined with alias "+g.alias+"("+g.src+", "+a[f].src+")"}c(a[f])}0===d&&b()},nigelgame.Sheet=function(a,b,c,d,e){this.alias=a,this.img=b,this.src=c,this.width=b.width,this.height=b.height,this.spriteWidth=d||this.width,this.spriteHeight=e||this.height,this.numCols=Math.floor(this.width/this.spriteWidth),this.numRows=Math.floor(this.height/this.spriteHeight),this.numSprites=this.numCols*this.numRows},nigelgame.Sheet.prototype.getSprite=function(a){return new nigelgame.Sprite(this,a)},nigelgame.Sprite=function(a,b){"number"==typeof b&&b%1===0&&(b={col:b%a.numCols,row:Math.floor(b/a.numCols)});var c=void 0!==b?void 0!==b.x?b.x:b.col?b.col*a.spriteWidth:0:0,d=void 0!==b?void 0!==b.y?b.y:b.row?b.row*a.spriteHeight:0:0,e=void 0!==b?void 0!==b.width?b.width:void 0!==b.col?a.spriteWidth:a.width-c:a.width-c,f=void 0!==b?void 0!==b.height?b.height:void 0!==b.row?a.spriteHeight:a.height-d:a.height-d;this.sheet=a,this.rect=new nigelgame.Rect({left:c,top:d,width:e,height:f})},nigelgame.wrapString=function(a,b,c){if(!a)return a;var d=".{1,"+b+"}(\\s|$)|.{"+b+"}|.+$",e=a.match(RegExp(d,"g"));c&&(e=e.slice(0,c));for(var f=0;f<e.length;++f)e[f]=e[f].trim();return e.join("\n")};